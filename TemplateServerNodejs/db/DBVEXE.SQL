CREATE SCHEMA VEXE;
USE VEXE;
/* CREATE TABLES */

CREATE TABLE KHACHHANG
(
	ID INT  ,
	TENKH NVARCHAR(50),
	GIOITINH NVARCHAR(5),
	CMND VARCHAR(20) ,
	DIENTHOAI VARCHAR(10) ,
	DIACHI NVARCHAR(100),
	EMAIL VARCHAR(50)  ,	
	PRIMARY KEY(ID)
);


CREATE TABLE TAIKHOAN
(
	TENDANGNHAP VARCHAR(20),
	MATKHAU VARCHAR(20),
    IDKHACHHANG INT,
    
    PRIMARY KEY(TENDANGNHAP)
);

ALTER TABLE TAIKHOAN
ADD CONSTRAINT FK_TAIKHOAN_KHACHHANG
FOREIGN KEY (IDKHACHHANG) REFERENCES KHACHHANG(ID);

CREATE TABLE NHAXE
(
	ID INT  ,
	TENNHAXE NVARCHAR(50)   ,
	DIENTHOAI VARCHAR(10)  ,
	EMAIL VARCHAR(50)  ,
	DIEMDANHGIA INT   ,
	PRIMARY KEY(ID)
);

CREATE TABLE LOAIXE
(
	ID INT  ,
    TENLOAI NVARCHAR(20),
    PRIMARY KEY(ID)
);

-- IF OBJECT_ID('TableName', 'U') IS NOT NULL
-- DROP TABLE TableName;
CREATE TABLE XE
(
	ID INT   ,
    BIENSO VARCHAR(20),
	IDNHAXE INT  ,
	IDLOAIXE INT  ,
    SOCHONGOI INT,	
	PRIMARY KEY(ID)
   
) ;

ALTER TABLE XE
ADD CONSTRAINT FK_XE_NHAXE
FOREIGN KEY (IDNHAXE) REFERENCES NHAXE(ID);

-- ALTER TABLE XE
-- DROP FOREIGN KEY FK_XE_LOAIXE;

ALTER TABLE XE
ADD CONSTRAINT FK_XE_LOAIXE
FOREIGN KEY (IDLOAIXE) REFERENCES LOAIXE(ID);




CREATE TABLE GHENGOI
(
	ID INT  ,
    TENGHENGOI VARCHAR(45),
    PRIMARY KEY(ID)
);


CREATE TABLE LOAITHANHTOAN
(
	ID INT  ,
	TENLOAITHANHTOAN NVARCHAR(70)  ,
	PRIMARY KEY(ID)
);


CREATE TABLE TUYENXE
(
	ID INT  ,
	DIEMDI INT  ,
	DIEMDEN INT  ,
	PRIMARY KEY(ID)
);

CREATE TABLE TRANGTHAI_CHUYENXE
(
	ID INT    ,
    TENTRANGTHAI NVARCHAR(20),
    PRIMARY KEY(ID)	
);


CREATE TABLE CHUYENXE
(
	ID INT  ,
	IDTUYENXE INT   ,
	IDXE INT  ,
	GIODI TIME ,
	GIODEN TIME ,
    GIAVE BIGINT,
    IDTRANGTHAI_CHUYENXE INT,
	PRIMARY KEY(ID)  
);

ALTER TABLE CHUYENXE
ADD CONSTRAINT FK_CHUYENXE_TRANGTHAICHUYENXE
FOREIGN KEY (IDTRANGTHAI_CHUYENXE) REFERENCES trangthai_chuyenxe(ID);

ALTER TABLE CHUYENXE
ADD CONSTRAINT FK_CHUYENXE_XE
FOREIGN KEY (IDTUYENXE) REFERENCES xe(ID);

ALTER TABLE CHUYENXE
ADD CONSTRAINT FK_CHUYENXE_TUYENXE
FOREIGN KEY (IDTUYENXE) REFERENCES tuyenxe(ID);

CREATE TABLE DATVEXE
(
	ID INT  ,
    IDKHACHHANGDATVE INT,
    SLNGUOI INT,
    IDCHUYENXE INT,
	PRIMARY KEY(ID)
    
);

ALTER TABLE DATVEXE
ADD CONSTRAINT FK_DATVEXE_KHACHHANG
FOREIGN KEY (IDKHACHHANGDATVE) REFERENCES khachhang(ID);

CREATE TABLE THANHTOAN
(
	ID INT  ,
    IDLOAITHANHTOAN INT,
	IDDATVEXE INT,
    TONGTIEN BIGINT,
    NGAYTHANHTOAN DATETIME,
	PRIMARY KEY (ID)
);

ALTER TABLE THANHTOAN
ADD CONSTRAINT FK_THANHTOAN_LOAITHANHTOAN
FOREIGN KEY (IDLOAITHANHTOAN) REFERENCES LOAITHANHTOAN(ID);

ALTER TABLE THANHTOAN
ADD CONSTRAINT FK_THANHTOAN_DATVEXE
FOREIGN KEY (IDDATVEXE) REFERENCES DATVEXE(ID);

CREATE TABLE CHITIETVEXE
(
	ID INT  ,
    IDDATVEXE INT,
    IDGHENGOI INT,
    TENNGUOIDI NVARCHAR(50),
    PRIMARY KEY(ID)
);

ALTER TABLE CHITIETVEXE
ADD CONSTRAINT FK_CHITIETVEXE_DATVEXE
FOREIGN KEY (IDDATVEXE) REFERENCES DATVEXE(ID);

ALTER TABLE CHITIETVEXE
ADD CONSTRAINT FK_CHITIETVEXE_GHENGOI
FOREIGN KEY (IDGHENGOI) REFERENCES GHENGOI(ID);

CREATE TABLE DANHGIA
(
	ID INT  ,    
	IDCHUYENXE INT,
    IDDATVEXE INT,
    DIEMDANHGIA INT,
	PRIMARY KEY (ID)
);

ALTER TABLE DANHGIA
ADD CONSTRAINT FK_DANHGIA_CHUYENXE
FOREIGN KEY (IDCHUYENXE) REFERENCES CHUYENXE(ID);

ALTER TABLE DANHGIA
ADD CONSTRAINT FK_DANHGIA_DAVEXE
FOREIGN KEY (IDDATVEXE) REFERENCES DATVEXE(ID);


select distinct cx.ID as IDCHUYENXE, nx.TENNHAXE,cx.GIODI,cx.GIODEN, lx.TENLOAI, cx.SOCHOTRONG , nx.DIEMDANHGIA, cx.GIAVE 
FROM NHAXE nx, XE x, CHUYENXE cx, LOAIXE lx 
WHERE  nx.ID=x.IDNHAXE and x.ID=cx.IDXE AND x.IDLOAIXE=lx.ID  AND cx.GIODI >= NOW()
AND nx.ID=1  AND x.IDLOAIXE=1 ;

select ctvx.IDGHENGOI, gn.TENGHENGOI from DATVEXE dvx, GHENGOI gn, CHITIETVEXE ctvx 
where dvx.ID=ctvx.IDDATVEXE and gn.ID=ctvx.IDGHENGOI and dvx.IDCHUYENXE=1;





















